---
sidebar_position: 1
title: Derivative Market Concept
---

# 衍生品市场概念

## 定义

在使用线性合约（相对于反向合约）的衍生品市场中，代码为 **AAA/BBB** 的合约\
使用报价货币 BBB 作为保证金和结算，提供对标的资产 AAA 的敞口。对于每个合约，\
报价单位是一单位 AAA 的 BBB 价格，例如一单位 ETH 的 USDT 价格。

**名义价值** - 持仓的名义价值为：`名义价值 = 数量 * 价格`。

**退款** - 在我们的清算系统中，退款是指增加账户**可用余额**的操作。\
资金的释放是由于账户上的负担被解除（例如取消限价单、将订单应付费用降低为做市商费用、使用更少的保证金为市价单提供资金等）。

## 永续市场交易生命周期

### 永续市场创建

市场首先通过即时启动功能创建，通过 `MsgInstantPerpetualMarketLaunch` 或 `MsgInstantExpiryFuturesMarketLaunch`，\
通过支付额外费用创建市场，无需治理批准。或者通过治理以正常方式创建，\
通过 `MsgPerpetualMarketLaunchProposal` 或 `MsgExpiryFuturesMarketLaunchProposal`。

### 余额管理

#### 向交易所存入资金

交易者可以通过发送 `MsgDeposit` 将资金（例如 USDT）存入交易所，该消息将代币从\
Cosmos-SDK bank 模块转移到交易者在 exchange 模块上的子账户存款。

存入给定的 `Amount` 代币将同时增加交易者子账户存款的 `AvailableBalance`\
和 `TotalBalance`，增加量为 `Amount`。

#### 从交易所提取资金

交易者可以通过发送 `MsgWithdraw` 从交易所提取资金，该消息将代币从交易者的子账户\
转移到交易所模块。

**提取要求：** 提取给定的 `Amount` 代币将同时减少交易者子账户\
存款的 `AvailableBalance` 和 `TotalBalance`，减少量为 `Amount`。注意：`Amount` 必须小于或等于\
`AvailableBalance`。

#### 在子账户之间转移资金

交易者可以通过发送 `MsgSubaccountTransfer` 在自己的子账户之间转移资金，该消息将代币从交易者的\
一个子账户存款转移到交易者拥有的另一个子账户。

子账户转账具有与正常提取相同的提取要求。

#### 向另一个交易所账户转移资金

交易者可以通过发送 `MsgExternalTransfer` 将资金转移到外部账户，该消息将资金从\
交易者的子账户转移到另一个第三方账户。

外部资金转账具有与正常提取相同的提取要求。

### 订单管理

#### 下限价单

交易者可以通过发送 `MsgCreateDerivativeLimitOrder` 提交限价买入或卖出订单。提交后，订单可以：

1. 在 Endblocker 批量拍卖中立即（完全或部分）与订单簿上的其他对手挂单匹配，\
   从而为用户建立持仓。
2. 添加到订单簿。

请注意，订单可能被部分匹配，剩余未匹配部分将被添加到\
订单簿。

#### 下市价单

交易者可以通过发送 `MsgCreateDerivativeMarketOrder` 提交市价买入或卖出订单。提交后，市价\
订单将在 Endblocker 批量拍卖中与订单簿上的其他对手挂单执行，从而\
为用户建立持仓。

#### 取消限价单

用户通过发送 `MsgCancelDerivativeOrder` 取消限价买入或卖出订单，该消息将从\
订单簿中移除用户的限价单。

### 增加持仓保证金

用户可以通过发送 `MsgIncreasePositionMargin` 增加持仓的保证金。

### 清算资不抵债的持仓

如果持仓的维持保证金比率被突破，第三方可以通过发送 `MsgLiquidatePosition` 清算任何用户的持仓。

**初始保证金要求**

这是创建新持仓时保证金与订单名义价值的比率要求，以及标记价格要求。\
额外标记价格要求背后的想法是，当交易价格和标记价格在时间上\
偏离太远时，最小化清算风险。给定初始保证金比率，订单必须满足两个要求：

* 保证金必须满足：`保证金 ≥ 初始保证金比率 * 价格 * 数量`，例如，在最大杠杆为 20 倍的市场中，\
  初始保证金比率将为 0.05。任何新持仓的保证金至少为其名义价值的 0.05。
* 保证金必须满足标记价格要求：
* `保证金 >= 数量 * (初始保证金比率 * 标记价格 - 盈亏)`

盈亏是如果以当前标记价格平仓，持仓的预期盈亏。求解标记价格，结果为：

* 对于买入：$\mathrm{标记价格}$ ≥ $\mathrm{\frac{保证金 - 价格 \* 数量}{(初始保证金比率 - 1) \* 数量\}}$
* 对于卖出：$\mathrm{标记价格}$ ≤ $\mathrm{\frac{保证金 + 价格 \* 数量}{(初始保证金比率 + 1) \* 数量\}}$

**维持保证金要求**

在活跃持仓的整个生命周期中，如果不满足以下保证金要求，持仓将\
面临清算。（注意：为简化表示但不失一般性，我们假设所考虑的持仓\
没有任何资金费率）。

* 对于多头：`保证金 >= 数量 * 维持保证金比率 * 标记价格 - (标记价格 - 入场价格)`
* 对于空头：`保证金 >= 数量 * 维持保证金比率 * 标记价格 - (入场价格 - 标记价格)`

**清算支付**

当您的持仓低于维持保证金比率时，任何人都可以清算该持仓。链上发生的情况是，\
自动创建一个与持仓大小相同的仅减仓市价单。市价单的最差价格定义为 _Infinity_ 或 _0_，\
这意味着它将以订单簿中可用的任何价格进行匹配。

执行仅减仓市价单的支付不会归持仓所有者所有。相反，剩余资金的一部分\
转移给清算机器人，另一部分转移给保险基金。分配比例在 exchange 参数中由\
`LiquidatorRewardShareRate` 定义。如果持仓的支付为负，即持仓的负盈亏大于其保证金，\
则保险基金将弥补缺失的资金。

还请注意，清算在区块中立即执行，在任何其他订单匹配之前发生。

### 资金费率支付

资金费率仅存在于永续市场，作为使交易价格与标记价格对齐的机制。它指的是\
在每个资金费率周期结束时（例如每小时），做多或做空合约的交易者之间交换的\
周期性支付。当资金费率为正时，多头支付空头。当它为负时，空头支付多头。

* `持仓规模 = 持仓数量 * 标记价格`
* `资金费率支付 = 持仓规模 * 每小时资金费率 (HFR)`
* `HFR = Cap((TWAP((合成VWAP执行价格 - 标记价格)/标记价格) + 每日利率) * 1/24)`
* `合成VWAP执行价格 = (价格_A*成交量_A +价格_B*成交量_B +价格_C*成交量_C)/(成交量_A + 成交量_B + 成交量_C)`
  * `A` 是市价买入批量执行
  * `B` 是市价卖出批量执行
  * `C` 是限价匹配批量执行

资金费率支付通过修改 `CumulativeFunding` 值应用于整个市场。每个持仓存储当前的\
`CumulativeFunding` 作为 `CumulativeFundingEntry`。后续的资金费率支付仅在持仓变化时应用，\
可以计算为：

* 资金费率支付
  * 对于多头：`资金费率支付 ← 持仓数量 * (累计资金费率 - 累计资金费率入场值)`
  * 对于空头：`资金费率支付 ← 持仓数量 * (累计资金费率入场值 - 累计资金费率)`
* `保证金' ← 保证金 + 资金费率支付`
* `累计资金费率入场值' ← 累计资金费率`

## 永续市场交易规范

### 持仓

交易者的持仓记录交易者进入衍生品合约的条件，\
定义如下：

* 持仓定义：
  * `数量`
  * `入场价格`
  * `保证金`
  * `持有数量`
  * `累计资金费率入场值`

例如，考虑 ETH/USDT 市场中的以下持仓：

* `数量` = -2
* `入场价格` = 2200
* `保证金` = 800
* `持有数量` = 1
* `累计资金费率入场值` = 4838123

该持仓代表 ETH/USDT 市场的 2 个合约的空头敞口，以 800 USDT 作为抵押，\
入场价格为 2200。`HoldQuantity` 代表交易者已下反向订单的持仓数量。\
`CumulativeFundingEntry` 代表持仓最后更新时的累计资金费率值。

持仓净额：

当子账户的现有持仓匹配新的普通订单时，新持仓将是\
现有持仓与新普通订单净额的结果。匹配的普通订单产生由 `FillQuantity`、`FillMargin` 和 `ClearingPrice`\
定义的持仓增量。

* 将持仓增量应用于同方向的持仓：
  * `入场价格' ← (数量 \* 入场价格 + 成交数量 \* 清算价格) / (数量 + 成交数量)`
  * `数量' ← 数量 + 成交数量`
  * `保证金' ← 保证金 + 成交保证金`
* 将持仓增量应用于相反方向的持仓：
  * `入场价格 - 不变`
  * `数量' ← 数量 - 成交数量`
  * `保证金' ← 保证金 \* (数量 - 成交数量) / 数量`

### 限价买入订单

限价买入订单试图通过提供指定数量的保证金作为抵押，\
以指定价格购买指定数量的衍生品合约。

### 限价卖出订单

限价卖出订单试图通过提供指定数量的保证金作为抵押，\
以指定价格卖出指定数量的衍生品合约。

匹配的持仓将**扣除费用**，费用取决于限价单是作为\
做市商订单还是吃单订单执行。

### 市价买入订单

市价买入订单试图使用子账户的可用余额作为保证金抵押，\
以指定的最差价格购买指定数量的衍生品合约。

Handler 和 EndBlocker 对市价单的执行在概念上与限价买入订单\
（立即匹配情况）相同，因为交易者传递的保证金由于\
初始最小保证金要求而隐式设置了最大价格限制。

### 市价卖出订单

市价卖出订单试图使用子账户的可用余额作为保证金抵押，\
以指定的最差价格卖出指定数量的衍生品合约。

Handler 和 EndBlocker 对市价单的执行在概念上与限价卖出订单\
（立即匹配情况）相同，因为交易者传递的保证金由于\
初始最小保证金要求而隐式设置了最小价格限制。

### 订单类型

* BUY (1)：标准买入订单，以当前市场价格或设定的限价购买资产。
* SELL (2)：标准卖出订单，以当前市场价格或设定的限价卖出资产。
* STOP\_BUY (3)：止损买入订单，一旦预言机价格达到或超过指定的触发价格，就会转换为常规买入订单。
* STOP\_SELL (4)：止损卖出订单，一旦预言机价格降至或低于指定的触发价格，就会变为常规卖出订单。
* TAKE\_BUY (5)：止盈买入订单，一旦预言机价格达到或降至指定的触发价格以下，就会转换为常规买入订单。
* TAKE\_SELL (6)：止盈卖出订单，一旦预言机价格达到或超过指定的触发价格，就会变为常规卖出订单。
* BUY\_PO (7)：仅挂单买入。此订单类型确保订单只会添加到订单簿，不会与现有订单匹配。它保证您将成为市场"做市商"而不是"吃单者"。
* SELL\_PO (8)：仅挂单卖出。类似于 BUY\_PO，这确保您的卖出订单只会向订单簿添加流动性，不会与现有订单匹配。
* BUY\_ATOMIC (9)：原子买入订单是一种立即执行的市价单，绕过频繁批量拍卖（FBA）。它适用于需要立即执行交易的智能合约。需要支付更高的费用，费用在全局交易所参数中定义。
* SELL\_ATOMIC (10)：原子卖出订单类似于 BUY\_ATOMIC，它以当前市场价格立即执行，绕过 FBA。

### 仅减仓订单（卖出持仓）

### 限价买入仅减仓订单

限价买入仅减仓订单试图通过指定的 `数量` ETH（**基础货币**）减少现有的多头敞口。\
平仓的支付将**扣除费用**。

### 限价卖出仅减仓订单

限价卖出仅减仓订单试图通过指定的 `数量` ETH（**基础货币**）减少现有的空头敞口。\
平仓的支付将**扣除费用**。
