---
sidebar_position: 1
title: 概念
---

# 概念

## 概述

`Permissions` 模块通过 RBAC（基于角色的访问控制）系统实现权限资产的创建。该模块作为基础原语，用于启动任何需要不同权限级别的资产，如稳定币（由中心化实体发行）、代币化国债和其他 RWA（现实世界资产）。

支持的功能包括对发送/接收的限制（冻结资产）、对铸造和销毁访问的控制、暂停所有地址的特定操作、管理操作管理，以及支持 Wasm 合约钩子以在模块之上进行进一步开发。

## `Permissions` 模块的工作原理

### 与 `TokenFactory` 模块的关系

`Permissions` 模块与 `TokenFactory` 模块紧密耦合。它允许用户通过为代币单位创建命名空间来对特定 `TokenFactory` 代币的发送、接收、铸造和销毁创建限制，在命名空间中，操作被分配给角色，角色被分配给地址。通过这种方式，只有具有正确角色的地址才被允许执行相应的操作。该模块本质上在 `TokenFactory` 代币单位之上构建了一个可选的权限层。

由于 `Permissions` 模块依赖于 `TokenFactory` 代币单位的存在才能运行，因此应首先启动 `TokenFactory` 代币单位，然后创建 `Permissions` 命名空间。

* 有关 `TokenFactory` 模块的文档，请参见 https://docs.biyachain.network/developers/modules/biyachain/tokenfactory
* 有关使用该模块启动代币的指南，请参见 https://docs.biyachain.network/guides/launch-a-token
  * 注意：`TokenFactory` 管理员不应更改为空地址 (biya1qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqe2hm49)，因为 `Permissions` 模块要求 `Permissions` 命名空间的创建者是对应 `TokenFactory` 代币单位的管理员。

一旦 `TokenFactory` 代币单位上线并为该代币创建了 `Permissions` 命名空间，就会在代币铸造、销毁、发送和接收期间执行检查，以确保相关操作具有正确的权限。

### 命名空间的组成部分

作为权限资产的 RBAC 系统实现，`Permissions` 模块定义了可以在命名空间内分配给角色的几个基本操作。命名空间作为单个资产的所有规则、参数和分配权限的容器。请注意，每个资产（代币单位）只能有一个命名空间。

命名空间的核心包括：

* 代币单位（Denom）
* 操作（Actions）
* 角色（Roles）
* 角色管理器（Role Managers）
* 角色执行者（Role Actors）
* 策略状态（Policy Statuses）
* 策略管理器（Policy Managers）
* Wasm 合约钩子（Wasm Contract Hook）

**代币单位（Denom）**

* `TokenFactory` 资产的代币单位。命名空间中的代币单位对应于同名的 `TokenFactory` 资产，命名空间的创建者也是 `TokenFactory` 资产的管理员

![image.png](/broken/files/oUOO2cLqKyG3PjTSl79u)

**操作（Actions）**

* 操作被映射/分配给角色，以授予角色执行该操作的权限
* 操作分为两类：用户操作和命名空间管理操作。以下是命名空间中所有可能的权限操作列表：
  * 用户操作：
    * `MINT` - 可以使用 `receiver` 字段向任何地址铸造，只要该地址具有 `RECEIVE` 操作的权限。如果未指定，默认地址是消息发送者的地址
    * `RECEIVE` - 该地址能够接收代币
    * `BURN` - 销毁自己的资金
    * `SEND` - 可以向任何具有 `RECEIVE` 权限的地址发送
    * `SUPER_BURN` - 可以从除自己钱包外的任何人的钱包中销毁资金，除非用户也具有销毁权限
  * 命名空间管理操作：
    * `MODIFY_POLICY_MANAGERS` - 更改命名空间内的策略管理器及其能力（是否可以禁用或密封）
    * `MODIFY_CONTRACT_HOOK` - 更改 Wasm 合约钩子
    * `MODIFY_ROLE_PERMISSIONS` - 更改角色到允许操作的映射（更改每个角色允许执行的操作）
    * `MODIFY_ROLE_MANAGERS` - 更改决定谁可以拥有角色的管理器
* 操作由唯一的 2 的幂整数标识（用于内部位掩码）：
  * `MINT` = 1
  * `RECEIVE` = 2
  * `BURN` = 4
  * `SEND` = 8
  * `SUPER_BURN` = 16
  * `MODIFY_POLICY_MANAGERS` = 134217728
  * `MODIFY_CONTRACT_HOOK` = 268435456
  * `MODIFY_ROLE_PERMISSIONS` = 536870912
  * `MODIFY_ROLE_MANAGERS` = 1073741824
* 权限由所有允许的操作值的十进制总和标识
  * 例如，接收、销毁和发送的权限将是 14 (2 + 4 + 8)

**角色（Roles）**

* 角色由执行者被允许执行的操作（权限）子集组成。每个角色可以有零个、一个或多个由角色管理器分配的操作
* 角色的操作表示分配给该角色的地址可以执行的允许操作。换句话说，角色授予执行角色指定的操作的权限
* 角色在命名空间启动时创建，或由被允许执行 `MODIFY_ROLE_PERMISSIONS` 操作的用户使用新的角色-操作映射更新命名空间时创建
* 角色通常由命名空间（管理员）定义，但有两种特殊类型的角色：
  * `EVERYONE` 角色
    * 有一个默认的 `EVERYONE` 角色分配给所有没有其他角色的地址
    * 如果没有为执行者分配任何角色，则 `EVERYONE` 角色适用，直到他们被分配另一个角色，此时 `EVERYONE` 角色不再适用
    * 请注意，此角色不必分配任何权限，但**`EVERYONE` 角色必须在创建时定义**（可以定义为不分配任何操作）
    * `EVERYONE` 角色不允许拥有 `MINT`、`SUPER_BURN` 或任何命名空间管理操作的权限。这意味着只有 `SEND`、`RECEIVE` 和 `BURN` 是允许分配给 `EVERYONE` 角色的操作
  * 黑名单角色
    * 任何没有允许操作的角色（包括 `EVERYONE`）将被视为黑名单角色。黑名单角色可以称为任何唯一名称
    * 黑名单角色优先于所有其他角色，因此分配给黑名单角色的任何地址将撤销所有权限，直到该地址不再被列入黑名单
    * 如果从地址中移除黑名单角色，该地址之前拥有的所有其他角色/权限将被恢复
      * 在 `EVERYONE` 没有权限的情况下，一旦地址收到另一个非黑名单角色，该地址将不再具有零权限/被列入黑名单，因为 `EVERYONE` 仅在没有任何其他角色时适用

**角色管理器（Role Managers）**

* 角色管理器具有将角色分配给其他地址（角色执行者）的能力
* 对于命名空间内定义的每个角色，需要一个或多个角色管理器来管理特定角色的地址列表
  * 这包括命名空间管理操作的角色：
    * `MODIFY_POLICY_MANAGERS` 角色管理器
    * `MODIFY_CONTRACT_HOOK` 角色管理器
    * `MODIFY_ROLE_PERMISSIONS` 角色管理器
    * `MODIFY_ROLE_MANAGERS` 角色管理器
* 角色管理器只能分配他们作为特定角色管理器的角色
* 一个地址可以同时是多个角色的角色管理器

**角色执行者（Role Actors）**

* 角色执行者，或简称为执行者，是由相应的角色管理器分配了一个或多个角色的地址
* 角色执行者被允许执行其任何角色允许的任何操作
  * 例如，如果角色 ABC 具有铸造、发送和接收的权限，那么任何具有角色 ABC 的角色执行者将被允许对命名空间资产进行 `mint`、`send` 和 `receive` 操作。假设角色 XYZ 具有 `burn` 和 `mint` 权限，并且执行者同时拥有角色 ABC 和 XYZ。那么该执行者将被允许对资产进行 `mint`、`send`、`receive` 和 `burn` 操作。

![image.png](/broken/files/LZGoRFYboeXrDepUQmYA)

**策略状态（Policy Statuses）**

* 每个操作都有一个关联的策略状态，可以启用/禁用和/或密封（可以在不密封的情况下启用或禁用，也可以启用或禁用并密封）。在内部，这由两个布尔值 `IsDisabled` 和 `IsSealed` 组成
  * 默认情况下，操作不会被禁用也不会被密封
* 策略状态决定整个命名空间中操作的状态。如果操作策略被禁用，任何用户都无法执行该操作，直到它再次启用
* 密封用户操作策略将不可逆地设置操作策略的 `IsDisabled`
  * **注意：密封命名空间管理操作（**`MODIFY_POLICY_MANAGERS`**、**`MODIFY_CONTRACT_HOOK`**、**`MODIFY_ROLE_PERMISSIONS`**、**`MODIFY_ROLE_MANAGERS`**）策略将导致该操作被永久禁用。虽然用户操作和命名空间管理操作都可以被密封为启用状态，但相应的命名空间管理操作的最终行为将实际上被永久禁用，而用户操作将被永久启用。**

**策略管理器（Policy Managers）**

* 策略管理器负责设置其批准操作的策略状态
* 当为操作设置策略管理器时，可以通过 `PolicyManagerCapabilities` 字段授予他们禁用和/或密封操作策略的权限
  * 策略管理器能力描述地址（策略管理器）是否可以禁用或密封操作。另一种说法是：它们描述策略管理器可以更改操作策略状态的程度
  * 请注意，策略管理器应该至少拥有其中一个操作的权限，因为拥有无法更新操作策略状态的策略管理器没有意义。如果两个权限都被移除，策略管理器将被完全移除

**Wasm 合约钩子（Wasm Contract Hook）**

* Wasm 合约钩子对于在权限命名空间和 `TokenFactory` 原语之上构建扩展功能很有用
* Wasm 合约钩子在地址接收权限资产时被调用。钩子可以由具有执行 `MODIFY_CONTRACT_HOOK` 操作角色的任何地址设置
* 传递给合约的信息包括 `fromAddr`、`toAddr`、`action` 和 `amount`。操作当前作为 `Action_RECEIVE` 传递

### 与命名空间交互

有四个相关的消息用于与权限模块交互：

* `MsgCreateNamespace` - 创建命名空间，包含角色权限、角色管理器、策略状态、策略管理器/能力和/或 Wasm 合约钩子的初始设置/参数
* `MsgUpdateNamespace` - 更新角色权限、角色管理器、策略状态、策略管理器/能力和/或 Wasm 合约钩子
* `MsgUpdateActorRoles` - 向地址分配或撤销角色
* `MsgClaimVoucher` - 为从 Biya Chain 模块转移到接收者失败的资产（由于缺乏 `RECEIVE` 权限）申领凭证。凭证只能由预期接收者在接收地址具有 `RECEIVE` 权限后申领。对于在外部拥有的地址之间发生的转账，由于缺乏权限而导致的转账失败不会创建凭证；而是回滚交易

### 默认命名空间值

在以下条件下，角色管理器、策略状态和策略管理器的默认命名空间值将在命名空间创建期间分配：

* 如果没有为任何角色设置角色管理器：
  * 命名空间创建者被设置为所有角色的角色管理器
  * 注意：如果在命名空间启动时为任何角色指定了至少一个角色管理器，则不会设置默认角色管理器，即使对于未指定角色管理器的角色也是如此
* 如果没有为给定操作设置任何策略状态：
  * 操作的策略状态设置为未禁用且未密封（除非在创建时另有规定）
* 如果没有为任何操作设置策略管理器/策略管理器能力（两者都在单个数据结构中表示）：
  * 所有操作的策略管理器设置为命名空间创建者
  * 策略管理器被授予禁用/启用操作和密封操作策略状态的能力

> **警告：如果设置了错误的权限，默认命名空间值不会阻止命名空间在创建时变得不可用。**

* 为了防止这种情况发生，**命名空间管理角色应在命名空间创建期间映射到命名空间管理操作，并且还应为每个命名空间管理角色设置角色管理器**（特别是可以修改角色管理器和角色配置的角色）在命名空间创建时
  * 这将防止以下情况：当角色未正确映射到权限时无法更新命名空间，由于没有地址有权更新角色管理器或分配角色而无法更新角色权限/角色管理器，以及没有地址有权创建/配置新角色

### 通过治理更新命名空间

命名空间设置可以通过治理覆盖，但默认情况下不能。这可以防止用户通过治理任意编辑他们不拥有的命名空间。要通过治理启用命名空间更新，应为 `Gov` 模块地址分配适当的角色/权限。
